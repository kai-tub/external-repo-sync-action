name: Verification Tests
on:
  push:
    paths:
      - "**.fish"
      - ".github/workflows/verification_tests.yml"
      - "action.yml"
    branches: [ master ]
  # TODO: Move PR section to own file with check
  pull_request:
    branches: [ master ]

env:
  GH_ACCESS_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}

jobs:
  test_full_pipeline_on_different_branch:
    name: Test push to own wiki on tmp branch
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current version
        uses: actions/checkout@v2
      - name: Check if user can run test (otherwise exit workflow)
        run: |
          [ "$GITHUB_ACTOR" = "$GITHUB_OWNER" ] || { echo "::warning::Skipping pipeline test, as $GITHUB_ACTOR has no acces to it!"; exit 0; }
        id: check_user
      - name: Create tmp file
        run: |
          mkdir -p tmp/
          out=$(mktemp tempfileXXXXXXXX --suffix=.action.tmp --tmpdir=./tmp/)
          out=$(basename "$out")
          echo "::set-output name=tempfile::$out"
        id: tempfile
      - name: Push with local action
        uses: ./
        with:
          source-directory: "./tmp/"
          branch: "test_push_to_branch"
          include-patterns: "*.action.tmp"
          delete-missing: "true"
        id: test_full_pipeline_on_different_branch
      - name: Test output
        run: |
          sol="./${{ steps.tempfile.outputs.tempfile }}"
          res="${{ steps.test_full_pipeline_on_different_branch.outputs.sync_result }}"
          [ "$sol" = "$res" ] || { echo "::error::Failed default settings test"; exit 1; }